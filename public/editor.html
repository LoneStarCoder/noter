<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="/style.css">
  <link id="theme-style" rel="stylesheet" href="/style.css">
</head>
<body>
  <button id="theme-toggle" style="position:fixed;top:10px;right:10px;z-index:10;">ðŸŒ™</button>

  <table>
    <tr>
      <td><a href="../../">Home</a></td>  
      <td><a href="/person/brody">Brody</a></td>
      <td><a href="/person/elizabeth">Elizabeth</a></td>
      <td><a href="/person/brennan">Brennan</a></td>
      <td><a href="/person/christian">Christian</a></td>
    </tr>
  </table>

  <div id="pad" contenteditable="false" spellcheck="false"></div>

  <button id="delete-btn" style="
    position: fixed;
    bottom: 10px;
    right: 10px;
    padding: 0.5rem 1rem;
    background: #c00;
    color: white;
    border: none;
    font-size: 14px;
    cursor: pointer;
  ">Delete Page</button>

  <script>
    const name = window.location.pathname.split('/').pop() || 'home';
    const protectedPages = ['home'];
    const pad = document.getElementById('pad');
    let password = localStorage.getItem(`pw_${name}`) || '';
    let saveTimer;

    function escapeHTML(text) {
    const div = document.createElement('div');
    div.innerText = text;
    return div.innerHTML;
  }

  function linkifySafe(raw) {
    const escaped = escapeHTML(raw);
    const urlRegex = /(\b(?:https?:\/\/)?(?:www\.)?[a-z0-9\-]+\.[a-z]{2,}(?:[^\s]*)?)/gi;
    return escaped.replace(urlRegex, (url) => {
      let href = url;
      if (!/^https?:\/\//i.test(url)) {
        href = 'https://' + url;
      }
      return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
  }


    function extractPlainText(el) {
      return el.innerText || el.textContent || "";
    }

    function loadPad() {
      fetch(`/load/${name}?password=${encodeURIComponent(password)}`)
        .then(res => {
          if (res.status === 401) {
            pad.innerHTML = '[ðŸ”’ This page is protected]';
            pad.contentEditable = false;
            const pw = prompt("This page is password protected. Enter password:");
            if (pw) {
              password = pw;
              localStorage.setItem(`pw_${name}`, password);
              loadPad();
            }
            throw new Error("Unauthorized");
          }
          return res.text();
        })
        .then(data => {
          pad.innerHTML = linkifySafe(data);
          pad.contentEditable = true;
        })
        .catch(err => console.warn(err));
    }

    loadPad();

    pad.addEventListener('input', () => {
      if (pad.contentEditable !== "true") return;

      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        const plain = extractPlainText(pad);
        fetch(`/save/${name}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: plain })
        });
      }, 500);
    });

    // Theme toggle logic
    const themeBtn = document.getElementById('theme-toggle');
    const themeStyle = document.getElementById('theme-style');
    const currentTheme = localStorage.getItem('theme') || 'light';
    themeStyle.href = currentTheme === 'dark' ? '/dark.css' : '/style.css';
    themeBtn.textContent = currentTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';

    themeBtn.addEventListener('click', () => {
      const isDark = themeStyle.href.includes('dark.css');
      themeStyle.href = isDark ? '/style.css' : '/dark.css';
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
      themeBtn.textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
    });

    // Delete logic
    const deleteBtn = document.getElementById('delete-btn');
    if (protectedPages.includes(name)) {
      deleteBtn.style.display = 'none';
    }

    deleteBtn.addEventListener('click', () => {
      if (!confirm("Are you sure you want to delete this page? This cannot be undone.")) return;

      fetch(`/delete/${name}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
            alert("Page deleted.");
            window.location.href = '/';
          } else {
            alert("Failed to delete page.");
          }
        });
    });
  </script>
</body>
</html>
